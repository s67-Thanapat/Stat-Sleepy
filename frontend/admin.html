<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>แอดมิน • จัดการข้อมูล</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#f7f8fc;--card:#fff;--fg:#0b1220;--muted:#6b7280;--blue:#2563eb;--red:#dc2626;--green:#059669;}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,Segoe UI,Roboto;}
    header{padding:18px 24px;background:#eef2ff;border-bottom:1px solid #e5e7eb;font-weight:700}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:18px;margin-bottom:18px}
    h2{margin:6px 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,select,button,textarea{padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    input,select,textarea{background:#fff;min-width:200px}
    button{cursor:pointer;font-weight:700}
    .btn{background:var(--blue);color:#fff;border:none}
    .btn-muted{background:#e5e7eb;color:#111}
    .btn-red{background:var(--red);color:#fff;border:none}
    .btn-green{background:var(--green);color:#fff;border:none}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border-top:1px solid #eef0f4;padding:8px 10px;text-align:left;font-size:14px;vertical-align:top}
    th{background:#fafbff}
    .right{margin-left:auto}
    .muted{color:var(--muted);font-size:13px}
    .center{display:flex;justify-content:center;align-items:center}
    .pill{padding:4px 8px;border-radius:999px;background:#eef2ff;font-weight:600}
    .danger{color:var(--red)}
    .ok{color:var(--green)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
    .progress{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .bar{height:100%;background:var(--blue);width:0%}
  </style>
</head>
<body>
<header>แอดมิน • จัดการข้อมูล</header>

<div id="app" class="wrap" style="display:none">
  <!-- สถานะผู้ใช้ -->
  <div class="card" id="whoCard">
    <div class="row" style="align-items:center">
      <div>
        <div id="who">กำลังตรวจสอบสิทธิ์...</div>
        <div class="muted">เฉพาะผู้ดูแลระบบเท่านั้นที่เข้าหน้านี้ได้</div>
      </div>
      <div class="right">
        <button id="logoutBtn" class="btn-red">Logout</button>
      </div>
    </div>
  </div>

  <!-- ✅ นำเข้าไฟล์ CSV -->
  <div class="card">
    <h2>นำเข้าไฟล์ CSV</h2>
    <div class="row" style="align-items:center">
      <input id="csvFile" type="file" accept=".csv" />
      <select id="mapping">
        <option value="v1">Sleep sessions v1: start_time,end_time,sleep_quality,note</option>
        <option value="v2">Sleep sessions v2: date,sleep_start,sleep_end,quality,note</option>
        <option value="health">Health logs: ใช้คอลัมน์ที่มีช่องว่าง (Person ID, Quality of Sleep, ...)</option>
      </select>
      <label class="checkbox" style="display:flex;align-items:center;gap:8px">
        <input id="assumeLocal" type="checkbox" checked />
        เวลาที่อ่านเป็นเวลาเครื่อง (ใช้กับโหมด sessions)
      </label>
      <button id="btnParse" class="btn-muted">พรีวิว</button>
      <button id="btnUpload" class="btn">อัปโหลด</button>
    </div>

    <div class="muted mono" style="margin-top:6px">
      <b>Health logs</b> รองรับหัวคอลัมน์ CSV: <code>Person ID</code>, <code>Quality of Sleep</code>, <code>Physical Activity Level</code>, <code>Stress Level</code>, <code>Heart Rate</code>, <code>Daily Steps</code>, <code>Age</code>, <code>Sleep Duration</code>, <code>Gender</code>, <code>Blood Pressure</code> (หรือ <code>bp_systolic,bp_diastolic</code>), <code>Occupation</code>, <code>Sleep Disorder</code>, <code>BMI Category</code> (รับได้ทั้งแบบมีช่องว่างและแบบ snake_case)
    </div>

    <div id="csvMsg" class="muted" style="margin-top:10px"></div>
    <div class="progress" style="margin-top:8px"><div id="progBar" class="bar"></div></div>

    <div id="previewWrap" style="margin-top:12px;display:none">
      <div class="muted" id="pvTitle">ตัวอย่าง 5 แถวแรกที่จะอัปโหลด</div>
      <table>
        <thead id="pvHead"></thead>
        <tbody id="pvBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ตาราง Health Logs -->
  <div class="card">
    <div class="row" style="align-items:center">
      <h2 style="margin-right:auto">Health Logs (อ่านอย่างเดียว)</h2>
      <button id="refresh" class="btn-muted">รีโหลด</button>
    </div>
    <table id="tbl">
      <thead>
        <tr>
          <th>Person ID</th>
          <th>Quality of Sleep</th>
          <th>Physical Activity Level</th>
          <th>Stress Level</th>
          <th>Heart Rate</th>
          <th>Daily Steps</th>
          <th>Age</th>
          <th>Sleep Duration</th>
          <th>Gender</th>
          <th>Blood Pressure</th>
          <th>Occupation</th>
          <th>Sleep Disorder</th>
          <th>BMI Category</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="13" class="center muted">กำลังโหลด...</td></tr>
      </tbody>
    </table>
    <div class="row" style="margin-top:8px">
      <button id="prev" class="btn-muted">ก่อนหน้า</button>
      <div class="pill" id="pageInfo">หน้า 1</div>
      <button id="next" class="btn-muted">ถัดไป</button>
    </div>
  </div>
</div>

<script>
  // ===== Supabase =====
  const SUPABASE_URL = "https://nbxuzdrutlvavirpzpjt.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ieHV6ZHJ1dGx2YXZpcnB6cGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODUzMDYsImV4cCI6MjA3Mzk2MTMwNn0.tD4noFRKDFcA9x-A5udQSjkhKuXbccPdohdFjd8Fyo4";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });
  const ADMIN_EMAILS = ["ozone.gg55@gmail.com","ozza.tv55@gmail.com"];

  let user = null;
  let page = 1;
  const pageSize = 10;
  let total = 0;

  const appEl = document.getElementById('app');
  const whoEl = document.getElementById('who');

  // ===== Admin gate =====
  async function requireAdmin() {
    const { data:{ session } } = await supabase.auth.getSession();
    if (!session) { location.href = "/pages/signin.html?next=/admin.html"; return; }
    user = session.user;
    if (!ADMIN_EMAILS.includes(user.email.toLowerCase())) { location.href = "/index.html?login=1"; return; }

    appEl.style.display = 'block';
    whoEl.innerHTML = `เข้าสู่ระบบด้วย: <b>${user.email}</b> <span class="ok">• Admin</span>`;
    await loadSessions();
  }

  // ===== Logout =====
  document.getElementById('logoutBtn').onclick = async () => {
    await supabase.auth.signOut();
    location.href = "/pages/signin.html";
  };

  // ===== CSV Import (เหมือนเดิม) =====
  const csvFile = document.getElementById('csvFile');
  const csvMsg  = document.getElementById('csvMsg');
  const mappingSel = document.getElementById('mapping');
  const assumeLocal = document.getElementById('assumeLocal');
  const pvBody = document.getElementById('pvBody');
  const pvHead = document.getElementById('pvHead');
  const previewWrap = document.getElementById('previewWrap');
  const progBar = document.getElementById('progBar');
  const pvTitle = document.getElementById('pvTitle');

  let parsedPayload = []; // rows พร้อม insert
  let parsedMode = "v1";

  document.getElementById('btnParse').onclick = async () => {
    parsedPayload = [];
    progBar.style.width = "0%";
    csvMsg.textContent = "กำลังอ่านไฟล์...";
    const file = csvFile.files?.[0];
    if (!file) { csvMsg.textContent = "กรุณาเลือกไฟล์ .csv"; return; }

    const text = await file.text();
    const rows = parseCSV(text);
    if (!rows.length) { csvMsg.textContent = "ไฟล์ว่าง"; return; }

    const headerRaw = rows[0].map(h => h.trim());
    const headerLC  = rows[0].map(h => h.trim().toLowerCase());
    const bodyRows = rows.slice(1).filter(r => r.some(c => (c||"").trim() !== ""));

    const mode = mappingSel.value; // v1 | v2 | health
    parsedMode = mode;

    let ok=0, bad=0;
    for (const r of bodyRows) {
      try {
        if (mode === "health") {
          const obj = mapHealthRowSpaced(headerRaw, headerLC, r);
          parsedPayload.push(obj);
        } else {
          const obj = (mode === "v1") ? mapV1(headerLC, r) : mapV2(headerLC, r);
          if (!obj.start_time || !obj.end_time) { bad++; continue; }
          parsedPayload.push({
            user_id: user.id,
            start_time: normalizeDate(obj.start_time, assumeLocal.checked),
            end_time:   normalizeDate(obj.end_time, assumeLocal.checked),
            sleep_quality: toInt(obj.sleep_quality),
            note: emptyNull(obj.note),
            source: "csv"
          });
        }
        ok++;
      } catch(e){ bad++; }
    }

    // พรีวิว
    previewWrap.style.display = "block";
    pvBody.innerHTML = "";
    pvHead.innerHTML = (mode === "health")
      ? `<tr>
          <th>#</th>
          <th>Person ID</th><th>Quality of Sleep</th><th>Physical Activity Level</th>
          <th>Stress Level</th><th>Heart Rate</th><th>Daily Steps</th>
          <th>Age</th><th>Sleep Duration</th><th>Gender</th>
          <th>Blood Pressure</th><th>Occupation</th><th>Sleep Disorder</th><th>BMI Category</th>
        </tr>`
      : `<tr><th>#</th><th>start_time</th><th>end_time</th><th>sleep_quality</th><th>note</th></tr>`;

    if (mode === "health") {
      parsedPayload.slice(0,5).forEach((p,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${i+1}</td>
          <td class="mono">${nz(p["Person ID"])}</td>
          <td>${nz(p["Quality of Sleep"])}</td>
          <td>${nz(p["Physical Activity Level"])}</td>
          <td>${nz(p["Stress Level"])}</td>
          <td>${nz(p["Heart Rate"])}</td>
          <td>${nz(p["Daily Steps"])}</td>
          <td>${nz(p["Age"])}</td>
          <td>${nz(p["Sleep Duration"])}</td>
          <td>${nz(p["Gender"])}</td>
          <td class="mono">${nz(p["Blood Pressure"])}</td>
          <td>${nz(p["Occupation"])}</td>
          <td>${nz(p["Sleep Disorder"])}</td>
          <td>${nz(p["BMI Category"])}</td>`;
        pvBody.appendChild(tr);
      });
      pvTitle.textContent = "ตัวอย่าง 5 แถวแรก (health_logs • ใช้คอลัมน์มีช่องว่าง)";
    } else {
      parsedPayload.slice(0,5).forEach((p,i)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td><td class="mono">${p.start_time}</td><td class="mono">${p.end_time}</td><td>${p.sleep_quality??""}</td><td>${p.note??""}</td>`;
        pvBody.appendChild(tr);
      });
      pvTitle.textContent = "ตัวอย่าง 5 แถวแรก (sleep_sessions)";
    }

    csvMsg.textContent = `อ่านแล้ว ${ok+bad} แถว • แปลงสำเร็จ ${ok} • ข้าม ${bad}`;
  };

  document.getElementById('btnUpload').onclick = async () => {
    if (!parsedPayload.length) { csvMsg.textContent = "ยังไม่มีข้อมูลพร้อมอัปโหลด (กดพรีวิวก่อน)"; return; }
    csvMsg.textContent = "กำลังอัปโหลด...";
    progBar.style.width = "1%";

    const table = (parsedMode === "health") ? "health_logs" : "sleep_sessions";
    const batchSize = 200;
    let done = 0, failed = 0;

    for (let i=0; i<parsedPayload.length; i+=batchSize) {
      const chunk = parsedPayload.slice(i, i+batchSize);
      const { error } = await supabase.from(table).insert(chunk);
      if (error) { failed += chunk.length; console.error(error); }
      else { done += chunk.length; }
      progBar.style.width = `${Math.round((i+chunk.length)/parsedPayload.length*100)}%`;
    }
    csvMsg.textContent = `อัปโหลดเสร็จ • สำเร็จ ${done} แถว • ล้มเหลว ${failed} แถว`;

    await loadSessions();
  };

  // ----- CSV helpers -----
  function parseCSV(text){
    const rows = []; let row=[], cell="", inQ=false;
    for (let i=0;i<text.length;i++){
      const ch=text[i], next=text[i+1];
      if (inQ){
        if (ch === '"' && next === '"'){ cell+='"'; i++; continue; }
        if (ch === '"'){ inQ=false; continue; }
        cell += ch;
      }else{
        if (ch === '"'){ inQ=true; continue; }
        if (ch === ','){ row.push(cell); cell=""; continue; }
        if (ch === '\n'){ row.push(cell); rows.push(row); row=[]; cell=""; continue; }
        if (ch === '\r'){ continue; }
        cell += ch;
      }
    }
    row.push(cell); rows.push(row);
    return rows;
  }

  // Sleep sessions v1
  function mapV1(headerLC, row){
    const idx = keyIndex(headerLC, ["start_time","end_time","sleep_quality","note"]);
    return {
      start_time: row[idx.start_time] || "",
      end_time: row[idx.end_time] || "",
      sleep_quality: row[idx.sleep_quality] || "",
      note: row[idx.note] || ""
    };
  }
  // Sleep sessions v2
  function mapV2(headerLC, row){
    const idx = keyIndex(headerLC, ["date","sleep_start","sleep_end","quality","note"]);
    const date = (row[idx.date]||"").trim();
    const s = (row[idx.sleep_start]||"").trim();
    const e = (row[idx.sleep_end]||"").trim();
    return {
      start_time: date && s ? `${date} ${s}` : "",
      end_time:   date && e ? `${date} ${e}` : "",
      sleep_quality: row[idx.quality] || "",
      note: row[idx.note] || ""
    };
  }

  // ===== Health logs (คีย์มีช่องว่าง ตรงกับตารางที่คุณมี) =====
  function mapHealthRowSpaced(headerRaw, headerLC, row){
    const findIdx = (...names) => {
      for (const n of names){
        let i = headerRaw.indexOf(n); if (i >= 0) return i;
        i = headerLC.indexOf(n.toLowerCase()); if (i >= 0) return i;
      }
      return -1;
    };
    const getRaw = (...names) => {
      const i = findIdx(...names);
      return i >= 0 ? (row[i] ?? "").trim() : "";
    };

    const intOrNull = (v)=>{ const n=parseInt(v,10); return Number.isFinite(n)?n:null; };
    const numOrNull = (v)=>{ const n=parseFloat(v); return Number.isFinite(n)?n:null; };
    const emptyNull = (v)=> v && String(v).trim() ? String(v).trim() : null;

    const out = {
      "Person ID": intOrNull(getRaw("Person ID","person_id","user_id")),
      "Quality of Sleep": intOrNull(getRaw("Quality of Sleep","quality_of_sleep","quality")),
      "Physical Activity Level": numOrNull(getRaw("Physical Activity Level","physical_activity_level","activity_level")),
      "Stress Level": numOrNull(getRaw("Stress Level","stress_level")),
      "Heart Rate": numOrNull(getRaw("Heart Rate","heart_rate")),
      "Daily Steps": numOrNull(getRaw("Daily Steps","daily_steps","steps")),
      "Age": intOrNull(getRaw("Age","age","age_years")),
      "Sleep Duration": numOrNull(getRaw("Sleep Duration","sleep_duration","sleep_duration_hours")),
      "Gender": emptyNull(getRaw("Gender","gender")),
      "Blood Pressure": null,
      "Occupation": emptyNull(getRaw("Occupation","occupation")),
      "Sleep Disorder": emptyNull(getRaw("Sleep Disorder","sleep_disorder")),
      "BMI Category": emptyNull(getRaw("BMI Category","bmi_category"))
    };

    const bpRaw = getRaw("Blood Pressure","blood_pressure");
    if (bpRaw){
      out["Blood Pressure"] = bpRaw;
    } else {
      const sys = intOrNull(getRaw("bp_systolic","systolic","bp_sys"));
      const dia = intOrNull(getRaw("bp_diastolic","diastolic","bp_dia"));
      out["Blood Pressure"] = (sys!=null && dia!=null) ? `${sys}/${dia}` : null;
    }

    return out;
  }

  function keyIndex(headerLC, keys){
    const out={}; for (const k of keys){ const i=headerLC.indexOf(k); out[k]= i>=0 ? i : -1; } return out;
  }

  function normalizeDate(v){ if (!v) return null; const d=new Date(v); if (Number.isNaN(d.getTime())) return null; return d.toISOString(); }
  function nz(v){ return (v==null ? "" : v); }

  // ===== ตาราง sleep_sessions (อ่านอย่างเดียว) =====
  const tbody = document.getElementById('tbody');
  async function loadSessions() {
    tbody.innerHTML = `<tr><td colspan="13" class="center muted">กำลังโหลด...</td></tr>`;
    const from = (page-1)*pageSize, to = from+pageSize-1;

    const { data, error, count } = await supabase
      .from('sleep_sessions')
      .select(`
        "Person ID",
        "Quality of Sleep",
        "Physical Activity Level",
        "Stress Level",
        "Heart Rate",
        "Daily Steps",
        "Age",
        "Sleep Duration",
        "Gender",
        "Blood Pressure",
        "Occupation",
        "Sleep Disorder",
        "BMI Category"
      `, { count: 'exact' })
      .range(from, to);

    if (error) {
      tbody.innerHTML = `<tr><td colspan="13" class="danger">โหลดรายการไม่สำเร็จ: ${error.message}</td></tr>`;
      return;
    }

    total = count || 0;
    document.getElementById('pageInfo').textContent = `หน้า ${page} / ${Math.max(1, Math.ceil(total/pageSize))}`;

    if (!data || data.length === 0) {
      tbody.innerHTML = `<tr><td colspan="13" class="center muted">ยังไม่มีข้อมูล</td></tr>`;
      return;
    }

    tbody.innerHTML = '';
    for (const r of data) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${nz(r["Person ID"])}</td>
        <td>${nz(r["Quality of Sleep"])}</td>
        <td>${nz(r["Physical Activity Level"])}</td>
        <td>${nz(r["Stress Level"])}</td>
        <td>${nz(r["Heart Rate"])}</td>
        <td>${nz(r["Daily Steps"])}</td>
        <td>${nz(r["Age"])}</td>
        <td>${nz(r["Sleep Duration"])}</td>
        <td>${nz(r["Gender"])}</td>
        <td class="mono">${nz(r["Blood Pressure"])}</td>
        <td>${nz(r["Occupation"])}</td>
        <td>${nz(r["Sleep Disorder"])}</td>
        <td>${nz(r["BMI Category"])}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // เปลี่ยนหน้า
  document.getElementById('prev').onclick = () => { if (page>1){ page--; loadSessions(); } };
  document.getElementById('next').onclick = () => {
    const last = Math.max(1, Math.ceil(total/pageSize));
    if (page<last){ page++; loadSessions(); }
  };
  document.getElementById('refresh').onclick = loadSessions;

  // ===== Misc helpers =====
  function readRow(tr){ const obj={}; tr.querySelectorAll('input').forEach(i=>obj[i.dataset.k]=i.value); return obj; }
  function toLocalInput(iso){ const d=new Date(iso); const pad=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; }
  function toInt(v){ const n=parseInt(v,10); return Number.isFinite(n)?n:null; }
  function intOrNull(v){ const n=parseInt(v,10); return Number.isFinite(n)?n:null; }
  function numOrNull(v){ const n=parseFloat(v); return Number.isFinite(n)?n:null; }
  function emptyNull(v){ return v && String(v).trim() ? String(v).trim() : null; }

  // start
  requireAdmin();
</script>
</body>
</html>
