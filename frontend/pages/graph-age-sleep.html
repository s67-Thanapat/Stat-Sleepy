<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bar Chart ชั่วโมงนอน/ความเครียด/คุณภาพ แยกตามอาชีพ</title>
  <link rel="stylesheet" href="../css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    .controls {
      margin-top: 16px;
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .controls button.active {
      background: #2563eb;
      color: #fff;
    }

    .legend {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: center;
      margin: 8px 0 0;
      font-size: 0.95rem;
      flex-wrap: wrap;
    }

    .legend .dot {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      display: inline-block;
      margin-right: 6px;
      vertical-align: middle;
    }
  </style>
</head>

<body>
  <section class="controls">
    <button id="btnSleep" class="active">Bar chart (avg การนอน ของแต่ละอาชีพ)</button>
    <button id="btnStress">Bar chart (avg stress ของแต่ละอาชีพ)</button>
    <button id="btnQuality">Bar chart (avg quality sleep ของแต่ละอาชีพ)</button>
  </section>

  <header class="container">
    <h1 id="heading">Bar Chart ชั่วโมงนอนเฉลี่ยแยกตามอาชีพ</h1>
    <nav><a href="../index.html">← กลับหน้าแรก</a></nav>
  </header>

  <main class="container">
    <section class="chart" style="height:360px;">
      <canvas id="occupationHistChart"></canvas>
      <p class="muted" style="margin-top:20px;" id="chartDesc">
        ค่าเฉลี่ยชั่วโมงการนอนต่อคืน แยกตามอาชีพ (แสดงสีตามความเหมาะสม)
      </p>
      <div id="legend" class="legend"></div>
      <p class="muted" id="referenceDesc">
        <a href="https://www.sleepfoundation.org/how-sleep-works/how-much-sleep-do-we-really-need"
          target="_blank">แหล่งอ้างอิง: National Sleep Foundation</a>
      </p>
    </section>
  </main>

  <script src="../js/config.js"></script>
  <script src="../js/api.js"></script>
  <script>
    let chartType = "sleep"; // sleep, stress, quality
    let chartObj = null;
    let allRows = [];

    const COLORS = {
      good: '#16a34a',  // เขียว
      warn: '#f59e0b',  // ส้ม
      bad: '#ef4444',  // แดง
      base: '#60a5fa'   // fallback
    };

    function pick(obj, names) {
      for (const n of names) {
        if (obj[n] != null && obj[n] !== '') return obj[n];
        const cap = n.replace(/^\w/, c => c.toUpperCase());
        if (obj[cap] != null && obj[cap] !== '') return obj[cap];
      }
      return undefined;
    }

    function getOccAvg(rows, field) {
      const fieldMap = {
        duration: ["duration", "Sleep Duration"],
        stress: ["stress", "Stress Level"],
        quality: ["quality", "Quality of Sleep"],
        occupation: ["occupation", "Occupation"]
      };



      const buckets = {};
      rows.forEach(r => {
        const occ = filterOccupation((pick(r, fieldMap.occupation) || "ไม่ระบุ").toString().trim());
        const vRaw = pick(r, fieldMap[field] || [field]);
        const v = Number(vRaw);
        if (!isFinite(v)) return;
        (buckets[occ] ||= []).push(v);
      });

      const arr = Object.entries(buckets)
        .filter(([_, v]) => v.length >= 3)
        .map(([label, v]) => ({ label, avg: v.reduce((s, n) => s + n, 0) / v.length }))
        .sort((a, b) => b.avg - a.avg);

      return arr;
    }

    function filterOccupation(occ) {
      if (!occ) return "ไม่ระบุ";
      const checkOcc = occ.toLowerCase();
      if (checkOcc.includes("engineer")) return "Engineer";
      if (checkOcc.includes("sales")) return "Sales";
      if (checkOcc === "manager") return;
      return occ;
    }
    function classifySleep(h) { // hours
      if (h < 6) return { tag: 'น้อยมาก', color: COLORS.bad };
      if (h >= 7 && h <= 9) return { tag: 'เหมาะสม', color: COLORS.good };
      return { tag: 'ควรปรับ', color: COLORS.warn }; // 6–<7 หรือ >9
    }
    function classifyStress(s) { // 1–10
      if (s <= 3) return { tag: 'ต่ำ', color: COLORS.good };
      if (s <= 6) return { tag: 'ปานกลาง', color: COLORS.warn };
      return { tag: 'สูง', color: COLORS.bad };
    }
    function classifyQuality(q) { // 1–10
      if (q >= 7) return { tag: 'ดี', color: COLORS.good };
      if (q >= 5) return { tag: 'พอใช้', color: COLORS.warn };
      return { tag: 'แย่', color: COLORS.bad };
    }

    function buildLegendHTML(mode) {
      if (mode === 'sleep') {
        return `
          <span><i class="dot" style="background:${COLORS.good}"></i>เหมาะสม (7–9 ชม.)</span>
          <span><i class="dot" style="background:${COLORS.warn}"></i>ควรปรับ (6–<span style="white-space:nowrap">7</span> หรือ &gt;9 ชม.)</span>
          <span><i class="dot" style="background:${COLORS.bad}"></i>น้อยมาก (&lt;6 ชม.)</span>
        `;
      }
      if (mode === 'stress') {
        return `
          <span><i class="dot" style="background:${COLORS.good}"></i>ต่ำ (1–3)</span>
          <span><i class="dot" style="background:${COLORS.warn}"></i>ปานกลาง (4–6)</span>
          <span><i class="dot" style="background:${COLORS.bad}"></i>สูง (7–10)</span>
        `;
      }
      return `
        <span><i class="dot" style="background:${COLORS.bad}"></i>แย่ (1–4)</span>
        <span><i class="dot" style="background:${COLORS.warn}"></i>พอใช้ (5–6)</span>
        <span><i class="dot" style="background:${COLORS.good}"></i>ดี (7–10)</span>
      `;
    }

    function renderChart({ labels, data, mode }) {
      const ctx = document.getElementById('occupationHistChart');
      if (!ctx) return;

      const categories = [];
      const colors = data.map(v => {
        let c;
        if (mode === 'sleep') { const o = classifySleep(v); categories.push(o.tag); c = o.color; }
        else if (mode === 'stress') { const o = classifyStress(v); categories.push(o.tag); c = o.color; }
        else { const o = classifyQuality(v); categories.push(o.tag); c = o.color; }
        return c;
      });

      if (chartObj) chartObj.destroy();
      chartObj = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: mode === 'sleep' ? 'ชั่วโมงนอนเฉลี่ย' :
              mode === 'stress' ? 'ความเครียดเฉลี่ย' : 'คุณภาพการนอนเฉลี่ย',
            data,
            backgroundColor: colors,
            borderColor: colors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y;
                  const cat = categories[ctx.dataIndex];
                  const unit = mode === 'sleep' ? ' ชม.' : '';
                  return `${v.toFixed(2)}${unit} • ${cat}`;
                }
              }
            }
          },
          scales: {
            x: { title: { display: true, text: 'อาชีพ' } },
            y: {
              beginAtZero: true,
              title: {
                display: true, text:
                  mode === 'sleep' ? 'ชั่วโมงนอนเฉลี่ย' :
                    mode === 'stress' ? 'ระดับความเครียดเฉลี่ย' : 'คุณภาพการนอนเฉลี่ย'
              }
            }
          }
        }
      });

      const desc = document.getElementById('chartDesc');
      const legend = document.getElementById('legend');
      const referenceDesc = document.getElementById('referenceDesc');

      if (mode === 'sleep') {
        desc.textContent = 'ค่าเฉลี่ยชั่วโมงการนอนต่อคืน แยกตามอาชีพ (ลงสีตามเกณฑ์ความเหมาะสม)';
        legend.innerHTML = buildLegendHTML(mode);
        referenceDesc.style.display = 'block';
      } else if (mode === 'stress') {
        desc.textContent = 'ค่าเฉลี่ยระดับความเครียด แยกตามอาชีพ (เขียว=ต่ำ, แดง=สูง)';
        legend.innerHTML = buildLegendHTML(mode);
        referenceDesc.style.display = 'block';
      } else {
        desc.textContent = 'ค่าเฉลี่ยคุณภาพการนอน แยกตามอาชีพ (เขียว=ดี, แดง=แย่)';
        legend.innerHTML = buildLegendHTML(mode);
        referenceDesc.style.display = 'block';
      }
    }

    async function updateChart(type) {
      let rows = allRows;
      if (rows && !Array.isArray(rows) && Array.isArray(rows.data)) rows = rows.data;

      const heading = document.getElementById('heading');
      if (type === 'sleep') {
        const arr = getOccAvg(rows, 'duration');
        renderChart({ labels: arr.map(e => e.label), data: arr.map(e => e.avg), mode: 'sleep' });
        heading.textContent = 'Bar Chart ชั่วโมงนอนเฉลี่ยแยกตามอาชีพ';
      } else if (type === 'stress') {
        const arr = getOccAvg(rows, 'stress');
        renderChart({ labels: arr.map(e => e.label), data: arr.map(e => e.avg), mode: 'stress' });
        heading.textContent = 'Bar Chart ความเครียดเฉลี่ยแยกตามอาชีพ';
      } else {
        const arr = getOccAvg(rows, 'quality');
        renderChart({ labels: arr.map(e => e.label), data: arr.map(e => e.avg), mode: 'quality' });
        heading.textContent = 'Bar Chart คุณภาพการนอนเฉลี่ยแยกตามอาชีพ';
      }
    }

    (async function () {
      allRows = await (fetchAllSessions?.(1000) ?? []);
      updateChart('sleep');
      document.getElementById("btnSleep").onclick = () => { chartType = 'sleep'; updateChart('sleep'); setActive('btnSleep'); };
      document.getElementById("btnStress").onclick = () => { chartType = 'stress'; updateChart('stress'); setActive('btnStress'); };
      document.getElementById("btnQuality").onclick = () => { chartType = 'quality'; updateChart('quality'); setActive('btnQuality'); };
    })();

    function setActive(id) {
      ["btnSleep", "btnStress", "btnQuality"].forEach(b => {
        document.getElementById(b).classList.toggle('active', b === id);
      });
    }
  </script>
</body>

</html>