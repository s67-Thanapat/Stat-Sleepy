<!doctype html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>อัปโหลด/นำเข้าข้อมูล</title>
  <link rel="stylesheet" href="../css/styles.css" />
</head>

<body>
  <header class="container">
    <h1>นำเข้าข้อมูลการนอน</h1>
    <nav><a href="../sleepstat.html">← กลับหน้าแรก</a>
      <a href="./signin.html">ล็อกอิน</a>
      <a href="./signin.html" style="display: none;">ล็อกเอาต์</a>
    </nav>
  </header>

  <main class="container">
    <!-- อัปโหลดไฟล์ CSV -->
    <section class="panel">
      <h2>อัปโหลด CSV</h2>
      <input type="file" id="fileInput" accept=".csv" />
      <button id="btnUpload">อัปโหลด</button>
      <p class="muted">รองรับ: <code>start_time,end_time,sleep_quality,note</code> หรือ
        <code>date,sleep_start,sleep_end,quality</code>
      </p>
    </section>

    <!-- ดึงจาก URL CSV -->
    <section class="panel">
      <h2>ดึงจาก URL CSV</h2>
      <input type="url" id="urlInput" placeholder="https://example.com/sleep.csv" />
      <button id="btnFetch">ดึงและนำเข้า</button>
      <p class="muted">เช่น Raw GitHub / Google Sheets export CSV / Dropbox (?dl=1)</p>
    </section>
    <!-- ฟอร์มบันทึก 1 รายการ -->
    <section class="panel">
      <h2>เพิ่มด้วยฟอร์ม (เพิ่ม 1 รายการ)</h2>

      <nav><a href="./survey.html">ไปที่ฟอร์มบันทึก 1 รายการ</a></nav>
      <p class="muted">สำหรับกรอกข้อมูลทีละรายการ</p>
    </section>
  </main>

  <!-- libs -->
  <!-- ถ้ายังไม่มี @supabase/supabase-js ให้เอาคอมเมนต์บรรทัดนี้ออก -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> -->
  <script src="./js/config.js"></script>
  <script src="./js/api.js"></script>
  <!-- ⭐ เพิ่มใหม่: ตัวช่วย Auth (ปุ่ม Login/Logout + requireAuth) -->
  <script src="./js/auth.js"></script>
  <!-- logic สำหรับปุ่มเดิม (อัปโหลด/URL) -->
  <script>
    const fileInput = document.getElementById('fileInput');
    const btnUpload = document.getElementById('btnUpload');
    const urlInput = document.getElementById('urlInput');
    const btnFetch = document.getElementById('btnFetch');

    btnUpload.addEventListener('click', async () => {
      const f = fileInput.files?.[0];
      if (!f) return alert('เลือกไฟล์ก่อน');
      const text = await f.text();
      try {
        const r = await ingestCsvText(text);
        alert(`นำเข้าแล้ว: ${r.inserted} แถว`);
      } catch (e) { alert('Error: ' + (e?.message || e)); }
    });

    btnFetch.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      if (!url) return alert('ใส่ URL ก่อน');
      try {
        const r = await ingestFromUrl(url);
        alert(`นำเข้าแล้ว: ${r.inserted} แถว`);
      } catch (e) { alert('Error: ' + (e?.message || e)); }
    });
  </script>

  <!-- ✅ ใหม่: logic ฟอร์มบันทึก 1 รายการ -->
  <script>
    const btnSave = document.getElementById('btnSave');
    const formMsg = document.getElementById('formMsg');

    btnSave.addEventListener('click', async () => {
      const d = document.getElementById('fDate').value;      // YYYY-MM-DD
      const st = document.getElementById('fStart').value;     // HH:mm
      const et = document.getElementById('fEnd').value;       // HH:mm
      const qv = document.getElementById('fQuality').value;
      const age = document.getElementById('fAge').value
      const note = document.getElementById('fNote').value.trim();

      if (!d || !st || !et) {
        formMsg.textContent = 'กรอก วันที่ / เวลาเริ่ม / เวลาตื่น ให้ครบก่อนนะ';
        return;
      }

      const startLocal = new Date(`${d}T${st}:00`);
      let endLocal = new Date(`${d}T${et}:00`);
      if (endLocal <= startLocal) endLocal.setDate(endLocal.getDate() + 1);

      try {
        const rows = await createSession({
          start_time: startLocal.toISOString(),
          end_time: endLocal.toISOString(),
          sleep_quality: qv !== '' ? Number(qv) : null,
          note: note || null,
          age_years: age !== '' ? Number(age) : null
        });
        formMsg.textContent = `บันทึกสำเร็จ (id: ${rows[0]?.id ?? '-'})`;
      } catch (e) {
        formMsg.textContent = 'บันทึกไม่สำเร็จ: ' + (e?.message || e);
      }
    });
  </script>
</body>

</html>