<script>
  // ‚≠ê ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const SUPABASE_URL = "https://nbxuzdrutlvavirpzpjt.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ieHV6ZHJ1dGx2YXZpcnB6cGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODUzMDYsImV4cCI6MjA3Mzk2MTMwNn0.tD4noFRKDFcA9x-A5udQSjkhKuXbccPdohdFjd8Fyo4";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  const form = document.getElementById("loginForm");
  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("password");
  const rememberEl = document.getElementById("remember");
  const msg = document.getElementById("msg");

  // SHOW/HIDE password
  document.getElementById("toggle").addEventListener("click", () => {
    const isPwd = passEl.type === "password";
    passEl.type = isPwd ? "text" : "password";
    document.getElementById("toggle").textContent = isPwd ? "HIDE" : "SHOW";
    passEl.focus();
  });

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏à‡∏≥‡πÑ‡∏ß‡πâ
  (function initRemember(){
    const saved = localStorage.getItem("ss_email");
    if(saved){ emailEl.value = saved; rememberEl.checked = true; }
  })();

  // ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢: resolve URL
  function resolveNext(next, fallback){
    const value = next || fallback || "/index.html";
    if (/^https?:\/\//i.test(value)) return value;
    return `${location.origin}${value.startsWith("/") ? value : `/${value}`}`;
  }

  // üîê Login + ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.style.color = "#0f172a";
    msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";

    const email = emailEl.value.trim();
    const password = passEl.value;

    if(rememberEl.checked) localStorage.setItem("ss_email", email);
    else localStorage.removeItem("ss_email");

    const { error: signErr } = await supabase.auth.signInWithPassword({ email, password });
    if (signErr) {
      msg.style.color = "crimson";
      msg.textContent = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${signErr.message}`;
      return;
    }

    // ‡∏î‡∏∂‡∏á user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    const { data: { user }, error: uErr } = await supabase.auth.getUser();
    if(uErr || !user){
      msg.style.color = "crimson";
      msg.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
      return;
    }

    // üîé 1) ‡∏´‡∏≤‡πÇ‡∏î‡∏¢ id ‡∏Å‡πà‡∏≠‡∏ô
    let { data: profile } = await supabase
      .from("profiles")
      .select("is_admin, display_name")
      .eq("id", user.id)
      .maybeSingle();

    // üîé 2) ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‚Üí ‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡∏≠‡∏µ‡πÄ‡∏°‡∏• (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô display_name ‡πÅ‡∏ó‡∏ô)
    if (!profile) {
      const { data: p2 } = await supabase
        .from("profiles")
        .select("is_admin")
        .eq("display_name", user.email)   // üëà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô .eq("email", user.email) ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå email
        .maybeSingle();
      profile = p2 || null;
    }

    const isAdmin = !!profile?.is_admin;

    // ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á: ‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û ?next= ‡∏Å‡πà‡∏≠‡∏ô ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≠‡∏¢ fallback ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
    const nextParam = new URLSearchParams(location.search).get("next");
    const fallback = isAdmin ? "/admin.html" : "/index.html?login=1";
    const finalUrl = resolveNext(nextParam, fallback);

    msg.style.color = "seagreen";
    msg.textContent = isAdmin ? "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô) ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤..." : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å...";
    location.href = finalUrl;
  });

  // ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
  document.getElementById("forgot").addEventListener("click", async (e) => {
    e.preventDefault();
    const email = emailEl.value.trim();
    if (!email) { msg.style.color = "crimson"; msg.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡πà‡∏≠‡∏ô"; return; }

    const redirectTo = `${location.origin}/reset.html`;
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
    if (error) {
      msg.style.color = "crimson";
      msg.textContent = `‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`;
    } else {
      msg.style.color = "seagreen";
      msg.textContent = "‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß";
    }
  });
</script>
