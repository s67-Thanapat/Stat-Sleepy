<script>
  // Supabase client
  const SUPABASE_URL = "https://nbxuzdrutlvavirpzpjt.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ieHV6ZHJ1dGx2YXZpcnB6cGp0Iiwicm9zZSI6ImFub24iLCJpYXQiOjE3NTgzODUzMDYsImV4cCI6MjA3Mzk2MTMwNn0.tD4noFRKDFcA9x-A5udQSjkhKuXbccPdohdFjd8Fyo4";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  const form = document.getElementById("loginForm");
  const emailEl = document.getElementById("email");
  const passEl  = document.getElementById("password");
  const rememberEl = document.getElementById("remember");
  const msg = document.getElementById("msg");

  // helpers
  function log(...a){ try{ console.log("[signin]",...a);}catch{} }
  function fail(text){ msg.style.color="crimson"; msg.textContent=text; }
  function ok(text){ msg.style.color="seagreen"; msg.textContent=text; }

  // build final redirect url safely
  function resolveNext(next, fallback){
    const v = next || fallback || "/index.html";
    if (/^https?:\/\//i.test(v)) return v;                  // full URL ok
    return `${location.origin}${v.startsWith("/")?v:`/${v}`}`; // path → absolute
  }

  // toggle password
  document.getElementById("toggle").addEventListener("click", () => {
    const isPwd = passEl.type === "password";
    passEl.type = isPwd ? "text" : "password";
    document.getElementById("toggle").textContent = isPwd ? "HIDE" : "SHOW";
  });

  // remember email
  (function initRemember(){
    const saved = localStorage.getItem("ss_email");
    if(saved){ emailEl.value = saved; rememberEl.checked = true; }
  })();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.style.color = "#0f172a";
    msg.textContent = "กำลังเข้าสู่ระบบ...";
    try {
      const email = emailEl.value.trim();
      const password = passEl.value;
      if(rememberEl.checked) localStorage.setItem("ss_email", email);
      else localStorage.removeItem("ss_email");

      // sign in
      const { error: signErr } = await supabase.auth.signInWithPassword({ email, password });
      if (signErr) { fail(`เข้าสู่ระบบไม่สำเร็จ: ${signErr.message}`); log(signErr); return; }

      // current user
      const { data: { user }, error: uErr } = await supabase.auth.getUser();
      if (uErr || !user){ fail("ไม่พบข้อมูลผู้ใช้หลังเข้าสู่ระบบ"); log(uErr); return; }
      log("user", user.id, user.email);

      // profiles by id → fallback by email
      let { data: profile, error: pErr1 } = await supabase
        .from("profiles")
        .select("is_admin,email")
        .eq("id", user.id)
        .maybeSingle();

      if (!profile) {
        const { data: p2, error: pErr2 } = await supabase
          .from("profiles")
          .select("is_admin")
          .eq("email", user.email)  // << ใช้คอลัมน์ email
          .maybeSingle();
        if (pErr2) log("profiles by email error", pErr2);
        profile = p2 || null;
      }

      const isAdmin = !!profile?.is_admin;
      log("isAdmin =", isAdmin, "profile =", profile);

      // build destination
      const qp = new URLSearchParams(location.search);
      const nextParam = qp.get("next");   // URLSearchParams จะ decode ให้อยู่แล้ว
      const fallback  = isAdmin ? "/admin.html" : "/index.html?login=1";
      const finalUrl  = resolveNext(nextParam, fallback);
      log("redirect →", finalUrl);

      ok(isAdmin ? "เข้าสู่ระบบสำเร็จ (แอดมิน) กำลังเปลี่ยนหน้า..." : "เข้าสู่ระบบสำเร็จ กำลังกลับหน้าแรก...");

      // robust redirect (หลายชั้นกัน fail)
      try { location.replace(finalUrl); } catch {}
      setTimeout(() => { try { window.location.assign(finalUrl); } catch {} }, 200);
      setTimeout(() => { window.location.href = finalUrl; }, 600);

    } catch (err) {
      log("fatal", err);
      fail("เกิดข้อผิดพลาดที่ไม่คาดคิด ลองใหม่อีกครั้ง");
    }
  });

  // forgot password
  document.getElementById("forgot").addEventListener("click", async (e) => {
    e.preventDefault();
    const email = emailEl.value.trim();
    if (!email) { fail("กรุณากรอกอีเมลก่อน"); return; }
    const redirectTo = `${location.origin}/reset.html`;
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
    if (error) fail(`ส่งลิงก์รีเซ็ตไม่สำเร็จ: ${error.message}`);
    else ok("ส่งลิงก์ตั้งรหัสผ่านไปที่อีเมลแล้ว");
  });
</script>
