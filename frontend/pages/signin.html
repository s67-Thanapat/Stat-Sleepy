<script>
  // ---------- CONFIG ----------
  const SUPABASE_URL = "https://nbxuzdrutlvavirpzpjt.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ieHV6ZHJ1dGx2YXZpcnB6cGp0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzODUzMDYsImV4cCI6MjA3Mzk2MTMwNn0.tD4noFRKDFcA9x-A5udQSjkhKuXbccPdohdFjd8Fyo4";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  const ADMIN_EMAILS = ["ozone.gg55@gmail.com", "ozza.tv55@gmail.com"]; 
  // üëÜ ‡πÉ‡∏™‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï

  const form = document.getElementById("loginForm");
  const emailEl = document.getElementById("email");
  const passEl  = document.getElementById("password");
  const rememberEl = document.getElementById("remember");
  const msg = document.getElementById("msg");

  function resolveNext(next, fallback){
    const v = next || fallback || "/index.html";
    if (/^https?:\/\//i.test(v)) return v;
    return `${location.origin}${v.startsWith("/") ? v : `/${v}`}`;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    msg.style.color = "#0f172a";
    msg.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";

    const email = emailEl.value.trim();
    const password = passEl.value;

    if(rememberEl.checked) localStorage.setItem("ss_email", email);
    else localStorage.removeItem("ss_email");

    const { error: signErr } = await supabase.auth.signInWithPassword({ email, password });
    if (signErr) { 
      msg.style.color="crimson"; 
      msg.textContent = `‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${signErr.message}`; 
      return; 
    }

    // ‚úÖ ‡∏ï‡∏£‡∏ß‡∏à‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ß‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö ADMIN_EMAILS ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isAdmin = ADMIN_EMAILS.includes(email.toLowerCase());

    const nextParam = new URLSearchParams(location.search).get("next");
    const fallback  = isAdmin ? "/admin.html" : "/index.html?login=1";
    const finalUrl  = resolveNext(nextParam, fallback);

    msg.style.color = "seagreen";
    msg.textContent = isAdmin
      ? "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Admin) ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô..."
      : "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å...";

    setTimeout(() => { window.location.href = finalUrl; }, 400);
  });

  // ‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
  document.getElementById("forgot").addEventListener("click", async (e) => {
    e.preventDefault();
    const email = emailEl.value.trim();
    if (!email) { msg.style.color = "crimson"; msg.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Å‡πà‡∏≠‡∏ô"; return; }
    const redirectTo = `${location.origin}/reset.html`;
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo });
    if (error) { msg.style.color="crimson"; msg.textContent = `‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`; }
    else { msg.style.color="seagreen"; msg.textContent = "‡∏™‡πà‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡πâ‡∏ß"; }
  });
</script>
