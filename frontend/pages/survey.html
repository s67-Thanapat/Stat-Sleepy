<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>บันทึกการนอน (ฟอร์ม)</title>
    <link rel="stylesheet" href="../css/styles.css" />
</head>

<body>
    <header class="container">
        <h1>บันทึกการนอน (ฟอร์ม)</h1>
        <nav>
            <a href="../main.html">← กลับหน้าแรก</a>
            <a href="./upload.html">→ อัปโหลด/นำเข้าข้อมูล</a>
        </nav>
    </header>
    <main class="container">
        <section class="panel">
            <h2>บันทึกด้วยฟอร์ม (เพิ่ม 1 รายการ)</h2>
            <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;">
                <label>วันที่
                    <input type="date" id="fDate" required />
                </label>
                <label>เวลาเริ่มนอน
                    <input type="time" id="fStart" required />
                </label>
                <label>เวลาตื่น
                    <input type="time" id="fEnd" required />
                </label>
                <label>คุณภาพการนอน (0–100)
                    <input type="number" id="fQuality" min="0" max="100" step="1" placeholder="เช่น 80" />
                </label>
                <label>ส่วนสูง (ซม.)
                    <input type="number" id="fHeight" min="50" max="250" step="0.1" placeholder="เช่น 170.5" />
                </label>
                <label>น้ำหนัก (กก.)
                    <input type="number" id="fWeight" min="20" max="300" step="0.1" placeholder="เช่น 60.0" />
                </label>
                <label>อายุ (ปี)
                    <input type="number" id="fAge" min="1" max="120" step="1" placeholder="เช่น 21" />
                </label>
            </div>
            <label style="display:block;margin-top:12px;">บันทึกเพิ่มเติม
                <input type="text" id="fNote" placeholder="เช่น ฝันดี / นอนดึก" />
            </label>
            <button id="btnSave" style="margin-top:12px;">บันทึกลงฐานข้อมูล</button>
            <p id="formMsg" class="muted" style="margin-top:8px;"></p>
        </section>
    </main>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script>
        const btnSave = document.getElementById('btnSave');
        const formMsg = document.getElementById('formMsg');
        btnSave.addEventListener('click', async () => {
            const d = document.getElementById('fDate').value;
            const st = document.getElementById('fStart').value;
            const et = document.getElementById('fEnd').value;
            const qv = document.getElementById('fQuality').value;
            const age = document.getElementById('fAge').value;
            const note = document.getElementById('fNote').value.trim();
            const height = document.getElementById('fHeight').value;
            const weight = document.getElementById('fWeight').value;
            if (!d || !st || !et) {
                formMsg.textContent = 'กรอก วันที่ / เวลาเริ่ม / เวลาตื่น ให้ครบก่อนนะ';
                return;
            }
            const startLocal = new Date(`${d}T${st}:00`);
            let endLocal = new Date(`${d}T${et}:00`);
            if (endLocal <= startLocal) endLocal.setDate(endLocal.getDate() + 1);
            try {
                const rows = await createSession({
                    start_time: startLocal.toISOString(),
                    end_time: endLocal.toISOString(),
                    sleep_quality: qv !== '' ? Number(qv) : null,
                    note: note || null,
                    height_cm: height !== '' ? Number(height) : null,
                    weight_kg: weight !== '' ? Number(weight) : null,
                    age_years: age !== '' ? Number(age) : null
                });
                formMsg.textContent = `บันทึกสำเร็จ (id: ${rows[0]?.id ?? '-'})`;
            } catch (e) {
                formMsg.textContent = 'บันทึกไม่สำเร็จ: ' + (e?.message || e);
            }
        });
    </script>
</body>

</html>