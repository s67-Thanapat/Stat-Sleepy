<!doctype html>
<html lang="th">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>กระจายช่วงเวลานอน</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/regression@2.0.1/dist/regression.min.js"></script>
</head>

<body style="margin: 0;">
    <header class="container">
        <h1 id="heading">กระจายช่วงเวลานอน (อายุ)</h1>
        <nav><a href="../index.html">← กลับหน้าแรก</a></nav>
    </header>
    <main class="container">
        <section class="chart" style="width:100%; height: calc(100vh - 180px);">
            <canvas id="scatterChart"></canvas>
            <div id="occFilter" style="margin:12px 0 0 0; display:flex; flex-wrap:wrap; gap:8px;"></div>
        </section>
    </main>
    <script src="../js/config.js"></script>
    <script src="../js/api.js"></script>
    <script>
        let chartObj = null;
        let allRows = [];
        let mode = "age";
        let showRegression = true;
        let showScatter = true;
        let occList = [];
        let occShow = {};

        function parseBP(bp) {
            if (!bp) return null;
            const m = String(bp).match(/^(\d+)/);
            return m ? Number(m[1]) : null;
        }

        function parseBMI(bmi) {
            if (!bmi) return null;
            if (bmi === "Underweight") return Math.random() * (18.5 - 0) + 0;
            else if (bmi === "Normal weight") return Math.random() * (24.9 - 18.51) + 18.51;
            else if (bmi === "Overweight") return Math.random() * (29.9 - 25) + 25;
            else if (bmi === "Obese") return Math.random() * (40 - 30) + 30;
        }

        function getColor(idx) {
            const palette = [
                "#60a5fa", "#f472b6", "#34d399", "#fbbf24", "#a78bfa", "#fb7185", "#facc15", "#38bdf8",
                "#f87171", "#4ade80", "#c084fc", "#f59e42", "#818cf8", "#f43f5e", "#a3e635", "#f472b6"
            ];
            return palette[idx % palette.length];
        }
        
        function filterOccupation(occ){
            if (!occ) return "ไม่ระบุ";
            const checkOcc = occ.toLowerCase();
            if (checkOcc.includes("engineer")) return "Engineer";
            if (checkOcc.includes("sales")) return "Sales";
            if (checkOcc === "manager") return null;
            return occ;
        }

        function getScatterByOccupation(rows, mode) {
            const occMap = {};
            rows.forEach(r => {
                const occRaw = r.occupation || r["Occupation"] || "ไม่ระบุ";
                const occ = filterOccupation(occRaw);
                let x = null;
                if (mode === "age") {
                    x = r.age ?? r["Age"];
                } else if (mode === "bp") {
                    x = parseBP(r.bloodPressure ?? r["Blood Pressure"]);
                } else if (mode === "stress") {
                    x = r.stress ?? r["Stress Level"];
                } else {
                    x = parseBMI(r.bmi ?? r["BMI"]);
                }
                const y = r.duration ?? r["Sleep Duration"];
                if (x != null && y != null && !isNaN(x) && !isNaN(y)) {
                    if (!occMap[occ]) occMap[occ] = [];
                    occMap[occ].push({ x: Number(x), y: Number(y) });
                }
            });
            return occMap;
        }

        function renderOccFilter(occList, occShow, onChange) {
            const div = document.getElementById("occFilter");
            div.innerHTML = occList.map((occ, i) =>
                `<label style="font-size:0.95em;">
                    <input type="checkbox" value="${occ}" ${occShow[occ] ? "checked" : ""} style="vertical-align:middle;"/>
                    <span style="color:${getColor(i)}">${occ}</span>
                </label>`
            ).join("");
            div.querySelectorAll("input[type=checkbox]").forEach(cb => {
                cb.onchange = () => {
                    occShow[cb.value] = cb.checked;
                    onChange();
                };
            });
        }

        function renderScatterWithRegressionByOcc(rows, mode, showRegression) {
            const ctx = document.getElementById('scatterChart');
            if (!ctx) return;
            if (chartObj) chartObj.destroy();

            const occMap = getScatterByOccupation(rows, mode);
            const datasets = [];
            let idx = 0;
            for (const occ of occList) {
                if (!occShow[occ]) continue;
                const points = occMap[occ] || [];
                if (points.length < 2) continue;
                const color = getColor(idx);
                // จุด scatter
                datasets.push({
                    label: occ,
                    data: points,
                    backgroundColor: color,
                    showLine: false,
                    pointRadius: 3,
                    order: 1
                });
                // Regression line (ถ้าเลือกให้แสดง)
                if (showRegression) {
                    const regData = points.map(p => [p.x, p.y]);
                    const result = regression.linear(regData);
                    const xMin = Math.min(...points.map(p => p.x));
                    const xMax = Math.max(...points.map(p => p.x));
                    const regLine = [
                        { x: xMin, y: result.predict(xMin)[1] },
                        { x: xMax, y: result.predict(xMax)[1] }
                    ];
                    datasets.push({
                        label: occ + " (regression)",
                        type: "line",
                        data: regLine,
                        borderColor: color,
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        order: 2
                    });
                }
                idx++;
            }

            chartObj = new Chart(ctx, {
                type: 'scatter',
                data: { datasets },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: () => {
                                    if (mode === "age") return "อายุ (ปี)";
                                    if (mode === "bp") return "ความดันโลหิต Systolic (mmHg)";
                                    if (mode === "stress") return "ระดับความเครียด (1-10)";
                                    if (mode === "BMI") return "ดัชนีมวลกาย (BMI)";
                                    return "";
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: "ชั่วโมงนอนเฉลี่ย"
                            },
                            grace: '20%'

                        }
                    }
                }
            });
        }

        async function updateChart() {
            if (!allRows.length) {
                allRows = await fetchAllSessions?.(1000) || [];
            }
            renderScatterWithRegressionByOcc(allRows, mode, showRegression);
            if (chartObj) {
                chartObj.data.datasets.forEach(ds => {
                    if (ds.type !== "line") {
                        ds.hidden = !showScatter;
                    }
                });
                chartObj.update();
            }

        }

        (async function () {
            allRows = await fetchAllSessions?.(1000) || [];
            // สร้าง occList และ occShow
            const occMap = getScatterByOccupation(allRows, mode);
            occList = Object.keys(occMap);
            occShow = {};
            occList.forEach(occ => occShow[occ] = true);

            renderOccFilter(occList, occShow, updateChart);
            updateChart();

            // เพิ่มปุ่มเลือก mode และปุ่มโชว์/ซ่อน regression
            const controls = document.createElement("section");
            controls.className = "controls";
            controls.style = "margin:16px 0; display:flex; flex-wrap: wrap;gap:6px; justify-content:center;";
            controls.innerHTML = `
                <button id="btnAge" class="active">Linear Regression (ชั่วโมงนอนเฉลี่ย vs อายุ)</button>
                <button id="btnBP">Linear Regression (ชั่วโมงนอนเฉลี่ย vs ความดันโลหิต Systolic)</button>
                <button id="btnStress">Linear Regression (ชั่วโมงนอนเฉลี่ย vs ระดับความเครียด)</button>
                <button id="btnBMI">Linear Regression (ชั่วโมงนอนเฉลี่ย vs ดัชนีมวลกาย)</button>
            `;
            document.body.insertBefore(controls, document.body.querySelector("header"));

            const toggle = document.createElement("section");
            toggle.className = "controls";
            toggle.style = "margin:16px 0; display:grid; gap:8px; justify-content:center;";
            toggle.innerHTML = `
                <button id="btnToggleReg" class="toggle on">ซ่อนเส้น Regression</button>
                <button id="btnToggleScatter" class="toggle on">ซ่อนจุดกระจาย</button>
            `;
            document.body.insertBefore(toggle, document.body.querySelector("main"));

            document.getElementById("btnAge").onclick = function () {
                mode = "age";
                // รีเฟรช occList/occShow ใหม่
                const occMap = getScatterByOccupation(allRows, mode);
                occList = Object.keys(occMap);
                occShow = {};
                occList.forEach(occ => occShow[occ] = true);
                renderOccFilter(occList, occShow, updateChart);
                updateChart();
                setActiveBtn("btnAge");
                document.getElementById("heading").textContent = "กระจายช่วงเวลานอน (อายุ)";
            };
            document.getElementById("btnBP").onclick = function () {
                mode = "bp";
                const occMap = getScatterByOccupation(allRows, mode);
                occList = Object.keys(occMap);
                occShow = {};
                occList.forEach(occ => occShow[occ] = true);
                renderOccFilter(occList, occShow, updateChart);
                updateChart();
                setActiveBtn("btnBP");
                document.getElementById("heading").textContent = "กระจายช่วงเวลานอน (ความดันโลหิต)";
            };
            document.getElementById("btnToggleReg").onclick = function () {
                showRegression = !showRegression;
                updateChart();
                this.textContent = showRegression ? "ซ่อนเส้น Regression" : "แสดงเส้น Regression";
                this.classList.toggle("on", showRegression);
            };
            document.getElementById("btnToggleScatter").onclick = function () {
                showScatter = !showScatter;
                if (chartObj) {
                    chartObj.data.datasets.forEach(ds => {
                        if (ds.type !== "line") {
                            ds.hidden = !showScatter;
                        }
                    });
                    chartObj.update();
                }
                this.textContent = showScatter ? "ซ่อนจุดกระจาย" : "แสดงจุดกระจาย";
                this.classList.toggle("on", showScatter);
            };
            document.getElementById("btnStress").onclick = function () {
                mode = "stress";
                const occMap = getScatterByOccupation(allRows, mode);
                occList = Object.keys(occMap);
                occShow = {};
                occList.forEach(occ => occShow[occ] = true);
                renderOccFilter(occList, occShow, updateChart);
                updateChart();
                setActiveBtn("btnStress");
                document.getElementById("heading").textContent = "กระจายช่วงเวลานอน (ระดับความเครียด)";
            }
            document.getElementById("btnBMI").onclick = function () {
                mode = "BMI";
                const occMap = getScatterByOccupation(allRows, mode);
                occList = Object.keys(occMap);
                occShow = {};
                occList.forEach(occ => occShow[occ] = true);
                renderOccFilter(occList, occShow, updateChart);
                updateChart();
                setActiveBtn("btnBMI");
                document.getElementById("heading").textContent = "กระจายช่วงเวลานอน (BMI)";
            }
            function setActiveBtn(id) {
                ["btnAge", "btnBP", "btnStress", "btnBMI"].forEach(bid => {
                    document.getElementById(bid).classList.toggle("active", bid === id);
                });
            }
        })();
    </script>
    <style>
        header,
        main {
            padding: 8px 12px;
        }

        .controls button.active {
            background: #2563eb;
            color: #fff;
        }

        .controls button.toggle.on {
            background: #fbbf24;
            color: #222;
        }
    </style>
</body>

</html>